<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="comtUser">

	<resultMap type="zeniware.community.vo.ComtVo" id="comtVoMap">
		<id column="COMP_ID"			property="compId" />
		<id column="FC_COMT_ID"			property="fcComtId" />
		<result	column="FC_COMT_ID"		property="fcComtId" />
		<result	column="FC_ADM_SEQ"		property="fcAdmSeq" />
		<result column="COMP_ID"		property="compId" />
		<result column="CUMT_NM"		property="cumtNm" />
		<result column="CUMT_COMMENT"	property="cumtComment" />
		<result column="ADM_ACT_YN"		property="admActYn" />
		<result column="OPEN_YN"		property="openYn" />
		<result column="REG_DATE"		property="regDate" />
		<result column="MOD_DATE"		property="modDate" />
		<result column="REG_USER_ID"	property="regUserId" />
		<result column="MOD_USER_ID"	property="modUserId" />
		<result column="MAST_GUBUN"		property="mastGubun" />
		<result column="JOIN_YN"		property="joinYn" />
		<result column="TYPE_GUBUN"		property="typeGubun" />
		<result column="TOTAL_NUM"		property="talNum" />
		<result column="USER_NAME"		property="userNm" />
	</resultMap>

	<select id="comtUser.getComntUserJoinList" parameterType="map" resultMap="comtVoMap">
		SELECT
			CI.FC_COMT_ID, CI.FC_ADM_SEQ, CI.COMP_ID, CI.CUMT_NM, CI.CUMT_COMMENT, CI.ADM_ACT_YN,
			CI.OPEN_YN, CI.REG_DATE, CI.MOD_DATE, CI.REG_USER_ID, CI.MOD_USER_ID,
			CAI.MAST_GUBUN, CAI.JOIN_YN
		FROM
			FC_CUMT_INFO CI
			INNER JOIN FC_CUMT_ADD_INFO CAI ON CI.FC_COMT_ID = CAI.FC_COMT_ID AND CAI.TYPE_GUBUN = 'C'
		WHERE 1 = 1
			AND CI.ADM_ACT_YN = #{admActYn, jdbcType=VARCHAR}
			AND CI.COMP_ID = #{compId, jdbcType=VARCHAR}
			AND CAI.USER_ID = #{userId, jdbcType=VARCHAR}
		ORDER BY CI.CUMT_NM  ASC
	</select>

	<!-- 커뮤니티 생성 전채(사용자 조회 시) 조회 -->
	<select id="comtUser.getComtAllListData" parameterType="map" resultMap="comtVoMap">
		SELECT
			CI.FC_COMT_ID, CI.FC_ADM_SEQ, CI.COMP_ID, CI.CUMT_NM, CI.CUMT_COMMENT, CI.ADM_ACT_YN,
			CI.OPEN_YN, CI.REG_DATE, CI.MOD_DATE, CI.REG_USER_ID, CI.MOD_USER_ID,
			(
				SELECT B.USER_NM FROM FC_CUMT_ADD_INFO A, FH_USER B
				WHERE A.FC_COMT_ID = CI.FC_COMT_ID
					AND A.COMP_ID = B.COMP_ID
					AND A.USER_ID = B.USER_ID
					AND A.MAST_GUBUN = 'M'
					AND A.TYPE_GUBUN = 'C'
					AND A.COMP_ID = #{compId, jdbcType=VARCHAR}
			) AS USER_NAME,
			(
				SELECT COUNT(USER_ID) + '명' FROM FC_CUMT_ADD_INFO A
				WHERE A.FC_COMT_ID = CI.FC_COMT_ID
					AND A.TYPE_GUBUN = 'C'
					AND A.COMP_ID = #{compId, jdbcType=VARCHAR}
			) AS TOTAL_NUM,
			(
				SELECT JOIN_YN FROM FC_CUMT_ADD_INFO A
				WHERE A.FC_COMT_ID = CI.FC_COMT_ID
					AND A.COMP_ID = CI.COMP_ID
					AND A.COMP_ID = #{compId, jdbcType=VARCHAR}
					AND A.USER_ID = #{userId, jdbcType=VARCHAR}
			) AS JOIN_YN,
			(
				SELECT MAST_GUBUN FROM FC_CUMT_ADD_INFO A
				WHERE A.FC_COMT_ID = CI.FC_COMT_ID
					AND A.COMP_ID = CI.COMP_ID
					AND A.COMP_ID = #{compId, jdbcType=VARCHAR}
					AND A.USER_ID = #{userId, jdbcType=VARCHAR}
					AND A.JOIN_YN = 'Y'
			) AS MAST_GUBUN
		FROM
			FC_CUMT_INFO CI
		WHERE 1 = 1
			AND CI.ADM_ACT_YN = #{admActYn, jdbcType=VARCHAR}
			AND CI.COMP_ID = #{compId, jdbcType=VARCHAR}
		ORDER BY CI.CUMT_NM  ASC
	</select>

	<select id="comtUser.getComtInofUserMastList" parameterType="map" resultType="hashmap">
		SELECT
			CAI.USER_ID,
			(
				SELECT USER_NAME FROM FH_USER WHERE USER_ID = CAI.USER_ID
			) AS USER_NAME
		FROM
			FC_CUMT_ADD_INFO CAI
		WHERE 1 = 1
			AND CAI.COMP_ID = #{compId, jdbcType=VARCHAR}
			AND CAI.TYPE_GUBUN = 'C'
			AND CAI.MAST_GUBUN = 'M'
	</select>

	<select id="comtUser.getBasicComtInfo" parameterType="map" resultType="hashmap">
		SELECT
			FC_ADM_SEQ, COMP_ID, CUMT_TYPE, FILE_SIZE_YN, FILE_SIZE,
			FILE_ADD_YN, FILE_ADD_CNT, FILE_NOT_NAME, REG_DATE, ADM_USER_ID
		FROM
			FC_ADMN_MAST
		WHERE 1 = 1
			AND COMP_ID = #{compId, jdbcType=VARCHAR}
	</select>

	<select id="comtUser.getComtInfoCnt" parameterType="zeniware.community.vo.ComtVo" resultType="int">
		SELECT
			COUNT(FC_ADM_SEQ) AS CNT
		FROM
			FC_CUMT_INFO
		WHERE 1 = 1
			AND CUMT_NM = #{cumtNm, jdbcType=VARCHAR}
	</select>

	<insert id="comtUser.insertNewComtInfoAdd" parameterType="zeniware.community.vo.ComtVo">
		INSERT INTO FC_CUMT_INFO
		(
			FC_COMT_ID,
			FC_ADM_SEQ,
			COMP_ID,
			CUMT_NM,
			CUMT_COMMENT,
			ADM_ACT_YN,
			OPEN_YN,
			REG_DATE,
			REG_USER_ID
		)
		SELECT
			#{fcComtId, jdbcType=VARCHAR},
			ifnull ( MAX(FC_ADM_SEQ), 1),
			#{compId, jdbcType=VARCHAR},
			#{cumtNm, jdbcType=VARCHAR},
			#{cumtComment, jdbcType=VARCHAR},
			#{admActYn, jdbcType=VARCHAR},
			#{openYn, jdbcType=VARCHAR},
			NOW(),
			#{regUserId, jdbcType=VARCHAR}
		FROM
			FC_CUMT_INFO
		WHERE 1 = 1
			AND COMP_ID = #{compId, jdbcType=VARCHAR}
	</insert>

	<insert id="comtUser.insertNewComtAddUserInfo" parameterType="zeniware.community.vo.ComtVo">
		INSERT INTO FC_CUMT_ADD_INFO
		(
			FC_COMT_ID,
			COMP_ID,
			USER_ID,
			DEPT_ID,
			TYPE_GUBUN,
			BOARD_INFO_ID,
			MAST_GUBUN,
			INVITE_YN, -- 10: 초대	-- 20: 미 초대	-- 30 : 일반가입	-- 40 : 가입요청
			JOIN_YN,
			REG_DATE
		) VALUES (
			#{fcComtId, jdbcType=VARCHAR},
			#{compId, jdbcType=VARCHAR},
			#{regUserId, jdbcType=VARCHAR},
			#{deptId, jdbcType=VARCHAR},
			#{typeGubun, jdbcType=VARCHAR},
			#{boardInfoId, jdbcType=NUMERIC},
			#{mastGubun, jdbcType=VARCHAR},
			#{inviteYn, jdbcType=VARCHAR},
			#{joinYn, jdbcType=VARCHAR},
			NOW()
		)
	</insert>

	<!-- 커뮤니티 가입신청 -->
	<insert id="comtUser.setInsertComtAllInfoUserAdd" parameterType="hashmap">
		INSERT INTO FC_CUMT_ADD_INFO
		(
			FC_COMT_ID,
			COMP_ID,
			USER_ID,
			DEPT_ID,
			TYPE_GUBUN,
			BOARD_INFO_ID,
			MAST_GUBUN,
			INVITE_YN,
			JOIN_YN,
			REG_DATE
		) VALUES (
			#{fcComtId, jdbcType=VARCHAR},
			#{compId, jdbcType=VARCHAR},
			#{userId, jdbcType=VARCHAR},
			#{deptId, jdbcType=VARCHAR},
			#{typeGubun, jdbcType=VARCHAR},
			#{boardInfoId, jdbcType=NUMERIC},
			#{mastGubun, jdbcType=VARCHAR},
			#{inviteYn, jdbcType=VARCHAR},
			#{joinYn, jdbcType=VARCHAR},
			NOW()
		)
	</insert>
</mapper>